name: Generate Tutorial PDF

on:
  push:
    branches:
      - main
    paths:
      - 'Tutorial.md'
      - 'public/tutorial-screenshots/**'
  workflow_dispatch:

jobs:
  convert-to-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra

      - name: Preprocess Tutorial.md (remove emojis for LaTeX)
        run: |
          # Create a temporary file with emojis removed for LaTeX compatibility
          # LaTeX (pdflatex) doesn't support Unicode emojis by default
          python3 << 'EOF'
          import sys
          import re
          
          # Read the original Tutorial.md
          with open('Tutorial.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Remove emojis using comprehensive Unicode ranges
          # This regex matches most common emojis including:
          # ðŸ“ðŸŽ¯ðŸš€ðŸ”“ðŸ”’âœ“ðŸ’¾ðŸ—‘ï¸ðŸ“‹ðŸŽ‰ etc.
          emoji_pattern = re.compile(
              "["
              "\U0001F300-\U0001F9FF"  # Most emoticons, symbols, pictographs
              "\U00002600-\U000027BF"  # Miscellaneous Symbols
              "\U00002700-\U000027BF"  # Dingbats
              "\U0001FA00-\U0001FAFF"  # Chess & Extended Pictographs
              "\U00002190-\U000021FF"  # Arrows
              "]+",
              flags=re.UNICODE
          )
          
          # Remove emojis from the content
          content_no_emojis = emoji_pattern.sub('', content)
          
          # Write to output file (using explicit file writing for better error handling)
          with open('Tutorial-processed.md', 'w', encoding='utf-8') as out:
              out.write(content_no_emojis)
          EOF

      - name: Convert Tutorial.md to PDF
        run: |
          # Convert markdown to PDF with embedded images
          # Using the preprocessed file without emojis
          pandoc Tutorial-processed.md \
            -o Tutorial.pdf \
            --from markdown \
            --to pdf \
            --pdf-engine=pdflatex \
            --variable geometry:margin=1in \
            --variable colorlinks=true \
            --variable linkcolor=blue \
            --variable urlcolor=blue \
            --variable toccolor=blue \
            --toc \
            --toc-depth=2 \
            -V documentclass=article \
            -V fontsize=11pt

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: tutorial-pdf
          path: Tutorial.pdf
          retention-days: 90

      - name: Create Release (on main branch only)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: Tutorial.pdf
          tag_name: tutorial-pdf-${{ github.run_number }}
          name: Tutorial PDF - ${{ github.run_number }}
          body: |
            Automatically generated PDF version of Tutorial.md

            Generated from commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

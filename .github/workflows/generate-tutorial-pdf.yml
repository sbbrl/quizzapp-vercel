name: Generate Tutorial PDF

on:
  push:
    branches:
      - main
    paths:
      - 'Tutorial.md'
      - 'public/tutorial-screenshots/**'
  workflow_dispatch:

jobs:
  convert-to-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra

      - name: Preprocess Tutorial.md (remove emojis for LaTeX)
        run: |
          # Create a temporary file with emojis removed for LaTeX compatibility
          # LaTeX (pdflatex) doesn't support Unicode emojis by default
          python3 - << 'EOF' > Tutorial-processed.md
          import sys
          import re
          
          # Read the original Tutorial.md
          with open('Tutorial.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Remove emojis (most emojis are in Unicode range U+1F300 to U+1F9FF)
          # This regex matches most common emojis including:
          # üìùüéØüöÄüîìüîí‚úìüíæüóëÔ∏èüìãüéâ etc.
          emoji_pattern = re.compile(
              "["
              "\U0001F300-\U0001F9FF"  # Emoticons & symbols
              "\U0001F600-\U0001F64F"  # Emoticons
              "\U0001F680-\U0001F6FF"  # Transport & Map
              "\U00002600-\U000027BF"  # Miscellaneous Symbols
              "\U0001F1E0-\U0001F1FF"  # Flags
              "\U00002702-\U000027B0"  # Dingbats
              "\U000024C2-\U0001F251"  # Enclosed characters
              "\U0001F900-\U0001F9FF"  # Supplemental Symbols
              "\U0001FA00-\U0001FA6F"  # Chess Symbols
              "\U0001FA70-\U0001FAFF"  # Symbols and Pictographs Extended-A
              "\U00002190-\U000021FF"  # Arrows
              "]+",
              flags=re.UNICODE
          )
          
          # Remove emojis from the content
          content_no_emojis = emoji_pattern.sub('', content)
          
          # Write to stdout
          print(content_no_emojis, end='')
          EOF

      - name: Convert Tutorial.md to PDF
        run: |
          # Convert markdown to PDF with embedded images
          # Using the preprocessed file without emojis
          pandoc Tutorial-processed.md \
            -o Tutorial.pdf \
            --from markdown \
            --to pdf \
            --pdf-engine=pdflatex \
            --variable geometry:margin=1in \
            --variable colorlinks=true \
            --variable linkcolor=blue \
            --variable urlcolor=blue \
            --variable toccolor=blue \
            --toc \
            --toc-depth=2 \
            -V documentclass=article \
            -V fontsize=11pt

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: tutorial-pdf
          path: Tutorial.pdf
          retention-days: 90

      - name: Create Release (on main branch only)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: Tutorial.pdf
          tag_name: tutorial-pdf-${{ github.run_number }}
          name: Tutorial PDF - ${{ github.run_number }}
          body: |
            Automatically generated PDF version of Tutorial.md

            Generated from commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

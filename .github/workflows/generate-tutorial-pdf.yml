name: Generate Tutorial PDF

on:
  push:
    branches:
      - main
    paths:
      - 'Tutorial.md'
      - 'public/tutorial-screenshots/**'
  workflow_dispatch:

jobs:
  convert-to-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pandoc and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra

      - name: Preprocess Tutorial.md (remove ALL emojis and variation selectors)
        run: |
          python3 << 'EOF'
          import re
          
          with open('Tutorial.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Remove emojis AND variation selectors (the invisible U+FE0F characters)
          emoji_pattern = re.compile(
              "["
              "\U0001F300-\U0001F9FF"  # Emoticons
              "\U00002600-\U000027BF"  # Misc symbols
              "\U00002700-\U000027BF"  # Dingbats
              "\U0001FA00-\U0001FAFF"  # Extended pictographs
              "\U00002190-\U000021FF"  # Arrows
              "\U0000FE00-\U0000FE0F"  # Variation selectors (THIS IS THE FIX!)
              "\U0001F000-\U0001F02F"  # Mahjong tiles
              "\U0001F0A0-\U0001F0FF"  # Playing cards
              "\U00002300-\U000023FF"  # Misc technical
              "\U0000200D"              # Zero-width joiner
              "]+",
              flags=re.UNICODE
          )
          
          content_no_emojis = emoji_pattern.sub('', content)
          
          with open('Tutorial-processed.md', 'w', encoding='utf-8') as out:
              out.write(content_no_emojis)
          EOF

      - name: Convert Tutorial.md to PDF
        run: |
          pandoc Tutorial-processed.md \
            -o Tutorial.pdf \
            --from markdown \
            --pdf-engine=pdflatex \
            --variable geometry:margin=1in \
            --variable colorlinks=true \
            --variable linkcolor=blue \
            --variable urlcolor=blue \
            --toc \
            --toc-depth=2 \
            -V documentclass=article \
            -V fontsize=11pt

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: tutorial-pdf
          path: Tutorial.pdf
          retention-days: 90

      - name: Commit PDF to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -f Tutorial.pdf
          git commit -m "Auto-generate Tutorial PDF [skip ci]" || echo "No changes to commit"
          git push
